---
title: Text analysis of wine tasting notes
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2) # Data visualization
library(readr) # CSV file I/O, e.g. the read_csv function
library(dplyr)
library(tidyr)
library(magrittr)
#text
library(tidytext)
library(spacyr)
library(cleanNLP)
init_spaCy(model_name = "en")
#library(topicmodels)
```

## Load data

```{r input}
wine <- read_csv("~/git_repo/opendata_viz/wine/wine.csv")
```

```{r variety}
variety <- wine %>% group_by(country, province) %>%
  dplyr::count(variety, sort=T) %>% 
  top_n(1)
```
```{r producer}
top_province <- wine %>% 
  dplyr::group_by(country, province) %>%
  dplyr::summarize(n=n()) %>%
  arrange(-n) %>%
  head(8)
```

```{r}
wine_select <- wine %>% 
  dplyr::filter(province %in% top_province$province) %>%
  dplyr::select(province, country, description, region_1, variety) %>%
  dplyr::mutate(id = row_number())

#keep data of province to be joint to parsed text
wine_index <- wine_select %>%
  dplyr::select(id, province,variety)
```

```{r}
#run_annotators works on files path of csv, or df (must state as_strings = TRUE)
wine_anno <-  get_combine(run_annotators(wine_select$description, as_strings = TRUE)) 
```
```{r}
wine_nlp <- wine_anno %>%
  filter(upos == 'ADJ', pos=='JJ') %>%
  filter(!lemma %in% c('black','red','green','white','dark','yellow'),
           word!='dried') %>%
  left_join(wine_index)
```

```{r}
top_word <- head(sort(table(wine_nlp$word), decreasing=T),20)

    #   dry      ripe     sweet      rich      good      soft      full     crisp 
    # 15810     14592     13196     12951      9651      8674      6487      6354 
    # fresh    tannic    little      fine     spicy       new     smoky   complex 
    #  6314      6194      5197      5144      4298      4207      4201      4177 
    # clean    smooth    bright delicious 
    #  4073      4017      3922      3704 
```

```{r}
top_adj = function(x) {
  x %>% 
    group_by(province) %>%
    count(lemma, sort=T) %>% 
    top_n(10)
}
```

```{r}
all_adj <- top_adj(wine_nlp)
#write.csv(all_adj, 'all_adj.csv')
```


```{r EDA}
prov = c('California', 'Oregon','Burgundy','Bordeaux','Mendoza', 'Northernspain',
         'Tuscany', 'Washington')
par(mfrow = c(2, 4))
#free scale facet doesn't work with non-cartesian
radial_plot = function(x) {
  all_adj %>% 
  filter(province==x) %>%
  ggplot(aes(reorder(lemma, -n), n)) + 
  geom_point(aes(col="red"),size=4) +
  geom_segment(aes(x = lemma, y = 0, xend = lemma, yend = n), color="darkred") +
  coord_flip() + 
  theme_minimal() + 
  theme(axis.title.y = element_blank(),axis.title.x = element_blank(),
  plot.title = element_text(face="bold", size=16, hjust = 0.5),
  axis.text.y = element_blank(),
  axis.text.x = element_text(face="bold", size=10),
  panel.grid.major = element_blank(),
  legend.position='None',
  text = element_text(family = "Helvetica"),
  plot.background = element_rect(fill = 'ghostwhite',color='white')) +
  labs(title = x,
  subtitle = "") 
}
for (i in prov) {
  p = radial_plot(i)
  ggsave(p, file=paste(i, '.png'))
}
```


```{r}
sample=as.data.frame(top_word)
wine_flavor <- wine_nlp %>%
  dplyr::filter(word %in% sample$Var1) %>%
  dplyr::select(word, variety) %>%
  dplyr::group_by(variety) %>%
  dplyr::count(word) %>%
  spread(word, n) %>%
  na.omit()
```



```{r PCA}
library(ggbiplot)
wine_flavor.variety=wine_flavor$variety

wine.pca <- prcomp(wine_flavor[,2:21], scale. = TRUE)
ggbiplot(wine.pca, 
         groups = wine_flavor.variety, labels= wine_flavor.variety
         ) +
  scale_color_discrete() +
  theme(legend.direction = 'horizontal', legend.position = 'None') +
  theme_void()
```

