---
title: "lego"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, error=F, warning=F)
library(tidyverse) # CSV file I/O, e.g. the read_csv function
library(RColorBrewer)
library(plotly) #contain hex to RGB conversion
#date
library(lubridate)
#machinelearning
library(caret)
#text
library(tidytext)
library(spacyr)
#theme
my_theme <- function(base_size = 12, base_family = "Helvetica"){
    theme(axis.title.y = element_blank(),axis.title.x = element_blank(),
    plot.title = element_text(face="bold", size=16),
    axis.text = element_text(face="bold"),
    plot.background = element_rect(fill = 'snow2',color='white'),
    legend.position = 'None', legend.title = element_blank())
}

```

## Load data

```{r input}
setwd("/Users/hannah/git_repo/opendata_viz/lego")
inventories <- read_csv("inventories.csv")
inventory_parts <- read_csv("inventory_parts.csv")
inventory_sets <- read_csv("inventory_sets.csv")
sets <- read_csv("sets.csv")
parts <- read_csv("parts.csv")
themes <- read_csv("themes.csv")
part_categories <- read_csv("part_categories.csv")
```



```{r pre_process}
colors <- read_csv("colors.csv")
#convert hex to rgb
colors <- colors %>% 
  mutate(hex = paste0("#", rgb),
         alpha = ifelse(is_trans == 't', 0.8, 0),
         rgb = toRGB(hex)) %>%
  separate(rgb, into=c('prefix','r','g','b','alp'), sep = "\\(|,|\\)") %>%
  mutate(rgb = paste(r, g, b, sep=',')
         #hsv = rgb2hsv(rgb)
         )
```

```{r merge}
merge <- sets %>% 
  left_join(inventories, by = "set_num") %>%
  left_join(inventory_parts, by = c("id" = "inventory_id")) %>%
  left_join(colors, by = c("color_id" = "id")) 
```

## main color
scatter with lines chart (simple yet fun)


## sort color
convert rgb to hsv space
```{r}
colors_rgb <- colors %>%
  select(r,g,b) %>% mutate_all(as.numeric)
colors_hsv <- t(rgb2hsv(t(colors_rgb))) %>% as.data.frame()
colors <- colors %>% cbind(colors_hsv)
```

```{r}
brick_colors = merge %>%
  mutate(decade = year- (year%%10)) %>%
  group_by(hex, h, decade) %>%
  dplyr::summarize(total = n())
  
```

## 7 decades
```{r distinctcolor}
pal <- unique(colors$hex)
names(pal) <- unique(pal) 


brick_colors %>%
          ggplot( aes(x = reorder(hex, h), y=1, fill = hex)) + 
          geom_col() + 
                 
          ggtitle("7 Decades of Lego brick colors") +
          scale_fill_manual(values = pal)+ 
          facet_grid(decade~., switch="both") + 
          theme_void( ) +
          my_theme() + theme(axis.text.y=element_blank(),
                             axis.text.x=element_blank()) +
  labs(caption = "source: Rebrickable")  

```
```{r}
brick_colors %>%
          ggplot( aes(y = reorder(hex, h), = decade , fill = hex)) + 
          geom_col() + 
          labs(x =   "", y = "")  +          
          ggtitle("7 Decades of Lego Brick Colors") +
          scale_fill_manual(values = pal)+ 
          theme_void( ) + 
          theme(plot.background = element_rect(fill = 'ghostwhite',color='white'),
                legend.position = "none") 
```

```{r distinctcolor}
pal <- unique(colors$hex)
names(pal) <- unique(pal) 

brick_colors_yr = merge %>%
  group_by(hex, h, year) %>%
  dplyr::summarize(total = n())

brick_colors_yr %>%
          ggplot(aes(x = year, y=1, fill = reorder(hex, h))) + 
          geom_col(color = 'white', size=0.01) + 
          labs(caption = "source: Rebrickable")  +    
          scale_x_continuous(breaks = seq(1950,2020, by=10)) + 
          ggtitle("Distinct Colors of Lego brick 1950 - 2017") +
          scale_fill_manual(values = pal) +
          theme_void( ) +
          my_theme() 

```






```{r}
colors %>%  
    ggplot(aes(x = hex, y=1, fill = hex)) + 
          geom_col(width = 0.6) + 
          labs(
            x = "", 
            y = "Unique Brick Colors", 
            title = "Lego brick colors, 1950-2017",
            subtitle = "Unique Lego color appearances by year",
            caption = "source: rebrickable.com/api/"           
            )  +          
          scale_fill_manual(values = pal)+ 
          scale_x_discrete() +          
          theme(
            panel.background = element_rect(fill = "#f0f0f0"),
            plot.background = element_rect(fill = "#f8f8f8"),
            text = element_text(size = 13),
            plot.title = element_text(size = rel(1)),
            plot.subtitle = element_text(size = rel(0.8)),   
            plot.caption = element_text(size = rel(0.6)),
            axis.title = element_text(size = rel(0.7), color = "gray15"),
            legend.position = "none", 
            axis.text.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            panel.grid = element_blank()
        )
```

