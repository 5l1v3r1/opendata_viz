---
title: ""
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, error=F, warning=F)
library(tidyverse) # CSV file I/O, e.g. the read_csv function
library(RColorBrewer)
library(viridis)
#plotly
library(plotly) #contain hex to RGB conversion
# set plotly user name
Sys.setenv("plotly_username"="HanYan")
# set plotly API key
Sys.setenv("plotly_api_key"="BMtBFRWCdY4ni069FJsx")

#date
library(lubridate)
#special
library(packcircles)
#text
library(tidytext)
library(quanteda)
library(udpipe)
#animate
library(gganimate)
#theme
my_theme <- function(base_size = 12, base_family = "Helvetica"){
    theme_minimal() +
    theme(axis.title.y = element_blank(),axis.title.x = element_blank(),
    plot.title = element_text(face="bold", size=16),
    axis.text = element_text(face="bold"),
    plot.background = element_rect(fill = 'ghostwhite',color='white'),
    legend.position = 'None', legend.title = element_blank())
}

```

#Section 1: input
## Load data
```{r input}
havana=readLines('/Users/hannah/git_repo/opendata_viz/lyric_repetitiveness/havana.txt') 
#lowercase everything
df = data.frame(line = 1:71, txt = havana)%>% 
#remove bracket
  mutate(txt_original = as.character(tolower(txt)),
         txt=str_replace_all(txt_original, '\\(.*?\\)', ''))
```

# Section 2: Text processing
```{r collocationmethod for reference}
# ud_model <- udpipe_download_model(language = "english")
# ud_model <- udpipe_load_model(ud_model$file_model)
# 
# x <- udpipe_annotate(ud_model, x = as.character(df$txt), doc_id = df$line)
# x <- as.data.frame(x) 
# 
# colloc <- keywords_collocation(x, term = "token", group = c("doc_id", "sentence_id"),
# ngram_max = 6, n_min = 2)
```

step 1: identify common phrases
```{r}
topfeatures(dfm(df$txt, ngrams = c(2,5), verbose = FALSE), n=30)
df%>%filter(grepl("ooh.na-na-na",txt))%>%count(1)

phraseHavana = c("my heart is in havana",
"ooh.na-na",
"took me back to east atlanta")
```

step 2: replace the phrases with dummy so one can still retrieve their locations, then tokenize the rest
```{r}
replacement = paste0("dummy",1:length(phraseHavana))

patternreplace = function(x, patterns, replacements = patterns, fill = NA, ...)
{
  stopifnot(length(patterns) == length(replacements))
  ans = x  
  empty = seq_along(x)
  
  for(i in seq_along(patterns)) {
    greps = grepl(patterns[[i]], x[empty], ... , ignore.case = T)
    ans[empty[greps]] = replacements[[i]]  
    empty = empty[!greps]
  }
  return(ans)
}

```

use 1 word to replace the phrase then dup it back, pattern replace and reverse pattern replace to incorporate custom token
```{r}
df_word <- df %>% 
  mutate(txt = patternreplace(txt, phraseHavana, replacement))%>%
  unnest_tokens(word, txt) %>% 
  mutate(id=1:n()) %>%
  mutate(word = patternreplace(word, replacement, phraseHavana))

df_combined <- df_word %>%
  group_by(word) %>%
  summarize(n = n(), id = min(id))
```



# Section 3: Visualization
## calc circle packing layout, return a list of dataframe
```{r fun}
circle_layout <- function(df, n) {
  packing <- circleProgressiveLayout(df$n, sizetype='area')
  #leave gaps between circles
  packing$radius=0.8*packing$radius
  
  #data contains coordinate/radius of each circle
  data = cbind(df, packing) 
  #dat.gg layout each vertice on the polygon which is a proxy for circle
  dat.gg <- circleLayoutVertices(packing, npoints=50)
  # out <- list()
  # out$packing = packing
  # out$data = data
  # out$dat.gg = dat.gg
  # return(out)
  # these are for checking by step
  circles = dat.gg %>% 
    left_join(data[c("id","word","n")], by = "id")
  return(circles)
}
```



```{r}
show_digest <- function(df) {
  df_dummy <- df %>% 
  mutate(n = 1)
  
  x <- circle_layout(df_dummy, n) %>% 
  mutate(state = as.factor("if no repetition"))
  y <- circle_layout(df, n) %>% 
  mutate(state = as.factor("full song"))

  z <- x %>%
  rbind(y)
  
  return(z)
}
```


```{r}
p <- show_digest(df_combined) %>%
  ggplot() + 
  geom_polygon(aes(x, y, fill = id, group = id, 
                   text =  paste0("word: ",word,
                                  "<br>", "#repeat: ",n)),  alpha = 0.8) +
  scale_fill_viridis(option = "plasma", direction = -1, begin = 0.1, end=0.8) +
  #geom_text(data = data, aes(x, y, size=value, label = group), color="black") +
  theme_void() + 
  theme(legend.position="none")+ 
  coord_equal() + 
  facet_grid(.~state)

p
```

